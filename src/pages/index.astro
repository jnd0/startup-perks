---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "../layouts/BaseLayout.astro";
import PerkCard from "../components/PerkCard.astro";
import SubmitPerkModal from "../components/SubmitPerkModal.astro";

const perks = ((await getCollection("perks")) as CollectionEntry<"perks">[])
  .filter((entry: CollectionEntry<"perks">) => entry.data.isActive)
  .sort((a: CollectionEntry<"perks">, b: CollectionEntry<"perks">) =>
    (b.data.creditValueUsd ?? 0) - (a.data.creditValueUsd ?? 0)
  );

const categories = [...new Set(perks.flatMap((perk: CollectionEntry<"perks">) => perk.data.categories))].sort();
const fundingStages = [...new Set(perks.flatMap((perk: CollectionEntry<"perks">) => perk.data.fundingStages))].sort();

const totalCreditValue = perks.reduce(
  (total: number, perk: CollectionEntry<"perks">) => total + (perk.data.creditValueUsd ?? 0),
  0
);
const verifiedCount = perks.filter((perk: CollectionEntry<"perks">) => perk.data.verified).length;
const currencyFormatter = new Intl.NumberFormat("en-US", {
  style: "currency",
  currency: "USD",
  maximumFractionDigits: 0,
});

const repositoryUrl = import.meta.env.PUBLIC_REPO_URL ?? "https://github.com/jnd0/startup-perks";
const repositoryBranch = import.meta.env.PUBLIC_REPO_BRANCH ?? "main";
const submissionApiUrl = import.meta.env.PUBLIC_SUBMISSION_API_URL ?? "";
const siteUrl = Astro.site ?? new URL("https://startup-perks.com");
const canonicalUrl = new URL("/", siteUrl).toString();
const organizationId = `${canonicalUrl}#organization`;
const websiteId = `${canonicalUrl}#website`;
const collectionId = `${canonicalUrl}#collection`;

const itemListElements = perks.map((perk: CollectionEntry<"perks">, index: number) => ({
  "@type": "ListItem",
  position: index + 1,
  url: new URL(`/perks/${perk.id}/`, siteUrl).toString(),
  name: `${perk.data.company}: ${perk.data.amountDisplay}`,
}));

const structuredData = {
  "@context": "https://schema.org",
  "@graph": [
    {
      "@type": "Organization",
      "@id": organizationId,
      name: "StartupPerks",
      url: canonicalUrl,
      logo: new URL("/favicon.svg", siteUrl).toString(),
      sameAs: [repositoryUrl],
    },
    {
      "@type": "WebSite",
      "@id": websiteId,
      name: "StartupPerks",
      url: canonicalUrl,
      description: "Open-source directory of startup credits, discounts, and trial programs.",
      inLanguage: "en",
      publisher: {
        "@id": organizationId,
      },
      potentialAction: {
        "@type": "SearchAction",
        target: `${canonicalUrl}?q={search_term_string}`,
        "query-input": "required name=search_term_string",
      },
    },
    {
      "@type": "CollectionPage",
      "@id": collectionId,
      url: canonicalUrl,
      name: "Startup credits and perks directory",
      description: "Search startup cloud credits, software discounts, and eligibility details.",
      isPartOf: {
        "@id": websiteId,
      },
      about: {
        "@type": "Thing",
        name: "Startup perks and credits",
      },
      mainEntity: {
        "@type": "ItemList",
        numberOfItems: perks.length,
        itemListElement: itemListElements,
      },
    },
  ],
};
---

<BaseLayout
  title="StartupPerks | Startup Credits, Free Trials, and SaaS Discounts"
  description="Explore 50+ startup credits and software perks with eligibility details, source links, and contribution-ready updates."
  canonicalUrl={canonicalUrl}
  ogType="website"
  structuredData={structuredData}
>
  <main class="page-shell">
    <header class="site-header">
      <div class="brand-meta">
        <div class="version-badge">REGISTRY V1.0</div>
        <h1 class="site-title">Startup<span>Perks</span></h1>
        <p class="site-tagline">High-fidelity directory of infrastructure grants and software perks for modern founders.</p>
      </div>
      
      <div class="header-actions">
        <button id="openSubmitModalBtn" class="button button-primary">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M5 12h14"/></svg>
          Submit Perk
        </button>
      </div>
    </header>

    <section class="stats-overview">
      <div class="stat-card">
        <span class="stat-label">Verified Market Value</span>
        <span class="stat-value highlight">{currencyFormatter.format(totalCreditValue)}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Active Registry Entries</span>
        <span class="stat-value">{perks.length}</span>
      </div>
      <div class="stat-card">
        <span class="stat-label">Trust Score (Verified)</span>
        <span class="stat-value">{verifiedCount}</span>
      </div>
    </section>

    <section class="controls-card card">
      <div class="controls-top">
        <div class="search-field">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.3-4.3"/></svg>
          <input id="searchInput" name="q" type="search" placeholder="Search by provider, stage, or categoryâ€¦" autocomplete="off" />
        </div>
        
        <div class="sort-field">
          <span class="field-label">Sort by</span>
          <select id="sortSelect">
            <option value="credit-desc">Highest Value</option>
            <option value="credit-asc">Lowest Value</option>
            <option value="recently-verified">Latest Verified</option>
            <option value="company-asc">Provider A-Z</option>
          </select>
        </div>
      </div>

      <div class="filter-sections">
        <div class="filter-row">
          <span class="row-label">Categories</span>
          <div class="chip-group">
            {categories.map((cat: string) => (
              <label class="filter-pill">
                <input type="checkbox" name="category" value={cat.toLowerCase()} />
                <span>{cat}</span>
              </label>
            ))}
          </div>
        </div>
        
        <div class="filter-row">
          <span class="row-label">Startup Stage</span>
          <div class="chip-group">
            {fundingStages.map((stage: string) => (
              <label class="filter-pill">
                <input type="checkbox" name="stage" value={stage.toLowerCase()} />
                <span>{stage}</span>
              </label>
            ))}
          </div>
        </div>

        <div class="filter-bar-footer">
          <label class="verified-switch">
            <input id="verifiedOnly" type="checkbox" />
            <span class="switch-text">Show Verified Only</span>
          </label>
          <button id="clearFilters" class="reset-button">Reset View</button>
        </div>
      </div>
    </section>

    <div class="ledger-container">
      <div class="ledger-head">
        <span class="head-col provider">Provider</span>
        <span class="head-col entry">Offer</span>
        <span class="head-col tags">Attributes</span>
        <span class="head-col action">Action</span>
      </div>
      <div id="resultsGrid" class="ledger-list">
        {perks.map((perk: CollectionEntry<"perks">) => <PerkCard perk={perk} />)}
      </div>
    </div>

    <div id="emptyState" class="empty-state" hidden>
      <div class="empty-content">
        <h3>No Registry Matches</h3>
        <p>Try broadening your query or clearing filters.</p>
        <button class="button" onclick="document.getElementById('clearFilters').click()">Reset System</button>
      </div>
    </div>

    <footer class="site-footer" aria-label="Site footer">
      <a href="/contributing/" class="footer-link">Contribute a perk</a>
      <p class="footer-note">
        Created with <span class="footer-heart" aria-hidden="true">&#10084;</span> for founders.
      </p>
      <a href={repositoryUrl} target="_blank" rel="noopener noreferrer" class="footer-source">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="currentColor" aria-hidden="true" focusable="false">
          <path d="M12 .5C5.65.5.5 5.66.5 12.03c0 5.1 3.3 9.42 7.88 10.95.58.1.8-.25.8-.56v-2.17c-3.2.7-3.88-1.36-3.88-1.36-.52-1.34-1.28-1.7-1.28-1.7-1.05-.72.08-.7.08-.7 1.16.08 1.78 1.2 1.78 1.2 1.03 1.77 2.7 1.26 3.35.96.1-.75.4-1.26.72-1.55-2.56-.3-5.25-1.29-5.25-5.74 0-1.27.45-2.31 1.2-3.13-.12-.3-.52-1.53.12-3.2 0 0 .98-.31 3.2 1.2a11.06 11.06 0 0 1 5.82 0c2.22-1.52 3.2-1.2 3.2-1.2.64 1.67.24 2.9.12 3.2.75.82 1.2 1.86 1.2 3.13 0 4.46-2.7 5.44-5.27 5.74.41.36.78 1.06.78 2.14v3.18c0 .31.21.67.8.56A11.54 11.54 0 0 0 23.5 12.03C23.5 5.66 18.35.5 12 .5Z"/>
        </svg>
        <span>Source on GitHub</span>
      </a>
    </footer>

    <SubmitPerkModal repositoryUrl={repositoryUrl} baseBranch={repositoryBranch} submissionApiUrl={submissionApiUrl} />
  </main>

  <script is:inline>
    function init() {
      const cards = Array.from(document.querySelectorAll(".perk-row"));
      const resultsGrid = document.getElementById("resultsGrid");
      const emptyState = document.getElementById("emptyState");
      const searchInput = document.getElementById("searchInput");
      const sortSelect = document.getElementById("sortSelect");
      const verifiedOnly = document.getElementById("verifiedOnly");
      const clearFiltersButton = document.getElementById("clearFilters");
      const openSubmitModalBtn = document.getElementById("openSubmitModalBtn");

      if (!resultsGrid) return;

      if(openSubmitModalBtn) {
          openSubmitModalBtn.onclick = () => {
              const modal = document.getElementById('submitModal');
              if(modal) {
                  modal.hidden = false;
                  document.body.style.overflow = "hidden";
              }
          };
      }

      const checkboxInputs = Array.from(document.querySelectorAll('input[type="checkbox"][name]'));
      const initialParams = new URLSearchParams(window.location.search);
      const initialSearch = initialParams.get("q");
      if (initialSearch) {
        searchInput.value = initialSearch;
      }

      const parseDataSet = (raw) => new Set((raw || "").split("|").filter(Boolean));
      const selectedValues = (name) =>
        Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map((input) => input.value.toLowerCase());

      const cardMatches = (card) => {
        const searchQuery = searchInput.value.trim().toLowerCase();
        const selectedCategories = selectedValues("category");
        const selectedStages = selectedValues("stage");
        const hasVerifiedOnly = verifiedOnly.checked;

        const cardSearch = card.dataset.search || "";
        const cardCategories = parseDataSet(card.dataset.categories);
        const cardStages = parseDataSet(card.dataset.stages);
        const isVerified = card.dataset.verified === "true";

        if (searchQuery && !cardSearch.includes(searchQuery)) return false;
        if (selectedCategories.length && !selectedCategories.some((value) => cardCategories.has(value))) return false;
        if (selectedStages.length && !selectedStages.some((value) => cardStages.has(value))) return false;
        if (hasVerifiedOnly && !isVerified) return false;

        return true;
      };

      const sortCards = (activeCards) => {
        const mode = sortSelect.value;
        return activeCards.sort((a, b) => {
          const creditA = Number(a.dataset.credit || "0");
          const creditB = Number(b.dataset.credit || "0");
          const verifiedAtA = Number(a.dataset.lastVerified || "0");
          const verifiedAtB = Number(b.dataset.lastVerified || "0");
          const companyA = a.dataset.company || "";
          const companyB = b.dataset.company || "";

          if (mode === "credit-asc") return creditA - creditB;
          if (mode === "recently-verified") return verifiedAtB - verifiedAtA;
          if (mode === "company-asc") return companyA.localeCompare(companyB);
          return creditB - creditA;
        });
      };

      const runFilters = () => {
        const visibleCards = cards.filter((card) => cardMatches(card));
        const query = searchInput.value.trim();
        const params = new URLSearchParams(window.location.search);
        if (query) params.set("q", query);
        else params.delete("q");
        const next = `${window.location.pathname}${params.toString() ? `?${params.toString()}` : ""}`;
        window.history.replaceState({}, "", next);

        cards.forEach((card) => {
          card.style.display = visibleCards.includes(card) ? "grid" : "none";
        });
        const sortedVisibleCards = sortCards([...visibleCards]);
        sortedVisibleCards.forEach((card) => resultsGrid.append(card));
        emptyState.hidden = visibleCards.length > 0;
      };

      searchInput.addEventListener("input", runFilters);
      sortSelect.addEventListener("change", runFilters);
      verifiedOnly.addEventListener("change", runFilters);
      checkboxInputs.forEach((checkbox) => checkbox.addEventListener("change", runFilters));

      clearFiltersButton.addEventListener("click", () => {
        searchInput.value = "";
        sortSelect.value = "credit-desc";
        checkboxInputs.forEach((checkbox) => checkbox.checked = false);
        verifiedOnly.checked = false;
        runFilters();
      });

      runFilters();
    }

    document.addEventListener('astro:page-load', init);
  </script>
</BaseLayout>

<style>
  .site-header {
    padding: 4rem 0 2rem;
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    gap: 3rem;
  }

  .version-badge {
    display: inline-block;
    padding: 0.2rem 0.6rem;
    background: #000;
    color: #fff;
    font-family: var(--font-mono);
    font-size: 0.55rem;
    font-weight: 700;
    border-radius: 4px;
    margin-bottom: 0.75rem;
    letter-spacing: 0.1em;
  }

  .site-title {
    font-size: clamp(2.5rem, 8vw, 4rem);
    font-weight: 800;
    margin: 0;
    line-height: 0.85;
    letter-spacing: -0.05em;
  }

  .site-title span {
    color: #cbd5e1;
    font-weight: 400;
  }

  .site-tagline {
    font-size: 1rem;
    color: var(--muted);
    margin: 0.75rem 0 0;
    max-width: 42ch;
    font-weight: 500;
    line-height: 1.4;
  }

  .header-actions {
    display: flex;
    gap: 1rem;
    padding-top: 0.25rem;
  }

  /* Stats Overview */
  .stats-overview {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 1rem;
    margin-bottom: 1.25rem;
  }

  .stat-card {
    background: var(--surface);
    border: 1px solid var(--line);
    padding: 1rem 1.5rem;
    border-radius: 12px;
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
    transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  }

  .stat-card:hover {
    border-color: var(--fg);
    box-shadow: 0 8px 20px -10px rgba(0,0,0,0.08);
  }

  .stat-label {
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--muted);
    letter-spacing: 0.08em;
  }

  .stat-value {
    font-size: 1.5rem;
    font-weight: 800;
    letter-spacing: -0.03em;
    line-height: 1;
  }

  .stat-value.highlight {
    color: var(--accent);
  }

  /* Controls Card */
  .controls-card {
    padding: 1.5rem 2rem;
    margin-bottom: 1.25rem;
    background: #fff;
    border-radius: 12px;
    display: grid;
    gap: 1.25rem;
    border: 1px solid var(--line);
    box-shadow: var(--shadow-sm);
  }

  .controls-top {
    display: grid;
    grid-template-columns: minmax(0, 1fr) auto;
    gap: 2rem;
    align-items: center;
  }

  .search-field {
    position: relative;
    display: flex;
    align-items: center;
    flex: 1;
    width: 100%;
    min-width: 0;
  }

  .search-field svg {
    position: absolute;
    left: 0;
    color: #94a3b8;
    pointer-events: none;
    width: 18px;
    height: 18px;
  }

  .search-field input {
    width: 100%;
    min-width: 0;
    height: 2.5rem;
    padding-left: 2rem;
    background: transparent;
    border: none;
    border-bottom: 1.5px solid #f1f5f9;
    border-radius: 0;
    font-size: 0.95rem;
    transition: all 0.2s;
    box-shadow: none;
  }

  .search-field input:focus {
    background: transparent;
    border-color: #000;
    box-shadow: none;
  }

  .sort-field {
    display: flex;
    align-items: center;
    gap: 0.75rem;
    font-size: 0.75rem;
    font-weight: 700;
    color: #64748b;
  }

  .sort-field select {
    appearance: none;
    background: none;
    border: none;
    font-weight: 800;
    color: #000;
    cursor: pointer;
    padding: 0.25rem 1.25rem 0.25rem 0.25rem;
    font-size: 0.8rem;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='14' height='14' viewBox='0 0 24 24' fill='none' stroke='black' stroke-width='3' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpath d='m6 9 6 6 6-6'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right center;
  }

  .filter-sections {
    display: grid;
    gap: 1rem;
    padding-top: 1rem;
    border-top: 1px solid #f1f5f9;
  }

  .filter-row {
    display: grid;
    grid-template-columns: 110px 1fr;
    align-items: center;
    gap: 1.5rem;
  }

  .row-label {
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    color: #94a3b8;
    letter-spacing: 0.1em;
  }

  .chip-group {
    display: flex;
    flex-wrap: wrap;
    gap: 0.4rem;
  }

  .filter-pill {
    cursor: pointer;
  }

  .filter-pill input {
    display: none;
  }

  .filter-pill span {
    display: inline-block;
    padding: 0.3rem 0.75rem;
    font-size: 0.7rem;
    font-weight: 700;
    background: #f8fafc;
    color: #475569;
    border-radius: 6px;
    border: 1px solid #f1f5f9;
    transition: all 0.1s;
  }

  .filter-pill:hover span {
    background: #f1f5f9;
    border-color: #e2e8f0;
  }

  .filter-pill input:checked + span {
    background: #000;
    color: #fff;
    border-color: #000;
  }

  .filter-bar-footer {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding-top: 0.75rem;
    border-top: 1px solid #f8fafc;
  }

  .verified-switch {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    cursor: pointer;
    font-size: 0.75rem;
    font-weight: 700;
  }

  .reset-button {
    background: none;
    border: none;
    font-size: 0.7rem;
    font-weight: 800;
    color: #94a3b8;
    text-decoration: underline;
    cursor: pointer;
    transition: color 0.2s;
  }

  .reset-button:hover {
    color: #000;
  }

  /* Registry Table */
  .ledger-container {
    background: #fff;
    border: 1px solid var(--line);
    border-radius: 12px;
    overflow: hidden;
    margin-bottom: 3rem;
    box-shadow: var(--shadow-sm);
  }

  .ledger-head {
    display: grid;
    grid-template-columns: 180px 1fr 220px 100px;
    padding: 0.75rem 0;
    background: #fcfcfc;
    border-bottom: 1px solid var(--line);
    font-size: 0.6rem;
    font-weight: 800;
    text-transform: uppercase;
    color: #94a3b8;
    letter-spacing: 0.1em;
  }

  .head-col {
    display: flex;
    align-items: center;
    padding: 0 2rem;
  }

  .head-col.provider,
  .head-col.entry,
  .head-col.tags {
    border-right: 1px solid #f1f5f9;
  }

  .head-col.action {
    justify-content: flex-end;
  }

  .empty-state {
    padding: 10rem 0;
    text-align: center;
  }

  .empty-content h3 {
    font-size: 2rem;
    font-weight: 800;
    margin-bottom: 1rem;
    letter-spacing: -0.02em;
  }

  .empty-content p {
    color: var(--muted);
    margin-bottom: 2.5rem;
  }

  .site-footer {
    position: relative;
    margin: 0 0 3rem;
    padding: 1rem 1.25rem;
    border: 1px solid var(--line);
    border-radius: 12px;
    background: linear-gradient(180deg, #fff 0%, #fcfcfc 100%);
    display: grid;
    grid-template-columns: 1fr auto 1fr;
    align-items: center;
    gap: 1rem;
    box-shadow: var(--shadow-sm);
    overflow: hidden;
  }

  .site-footer::after {
    content: "";
    position: absolute;
    inset: auto -25% -56% -25%;
    height: 75%;
    background: radial-gradient(circle at 50% 0%, rgba(190, 242, 100, 0.18), transparent 70%);
    pointer-events: none;
  }

  .footer-link {
    position: relative;
    z-index: 1;
    display: inline-flex;
    align-items: center;
    gap: 0.45rem;
    padding: 0.35rem 0.7rem;
    border-radius: 999px;
    border: 1px solid #e2e8f0;
    background: #fff;
    font-size: 0.69rem;
    font-weight: 800;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    color: #475569;
    transition: all 0.2s ease;
    justify-self: start;
  }

  .footer-link::before {
    content: "";
    width: 5px;
    height: 5px;
    border-radius: 999px;
    background: var(--highlight);
    box-shadow: 0 0 0 3px rgba(190, 242, 100, 0.2);
  }

  .footer-link:hover {
    border-color: #cbd5e1;
    color: #0f172a;
    transform: translateY(-1px);
    box-shadow: 0 6px 16px -12px rgba(15, 23, 42, 0.45);
  }

  .footer-link:focus-visible {
    outline: 2px solid #0f172a;
    outline-offset: 2px;
  }

  .footer-note {
    position: relative;
    z-index: 1;
    margin: 0;
    color: #64748b;
    font-size: 0.8rem;
    font-family: var(--font-mono);
    letter-spacing: -0.01em;
    justify-self: center;
    text-align: center;
  }

  .footer-heart {
    display: inline-block;
    margin: 0 0.2rem;
    color: #e11d48;
    font-size: 1.12em;
    line-height: 1;
    transform: translateY(1px);
  }

  .footer-source {
    position: relative;
    z-index: 1;
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    justify-self: end;
    font-size: 0.72rem;
    font-weight: 700;
    letter-spacing: 0.04em;
    color: var(--muted);
    text-decoration: underline;
    text-underline-offset: 2px;
    transition: color 0.2s ease;
  }

  .footer-source:hover {
    color: var(--fg);
  }

  .footer-source svg {
    width: 0.86rem;
    height: 0.86rem;
  }

  .footer-source:focus-visible {
    outline: 2px solid #0f172a;
    outline-offset: 2px;
  }

  @media (max-width: 1100px) {
    .site-header {
      flex-direction: column;
      padding: 4rem 0 2rem;
    }
    .stats-overview {
      grid-template-columns: 1fr;
    }
    .controls-top {
      grid-template-columns: 1fr;
      gap: 1.5rem;
    }
    .filter-row {
      grid-template-columns: 1fr;
      gap: 0.75rem;
    }
    .ledger-head {
      display: none;
    }
    .site-footer {
      grid-template-columns: 1fr;
      justify-items: center;
      gap: 0.75rem;
      padding: 0.9rem 1rem;
    }
    .footer-link,
    .footer-note,
    .footer-source {
      justify-self: center;
    }
  }
</style>
