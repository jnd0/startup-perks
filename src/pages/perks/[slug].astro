---
import { getCollection } from "astro:content";
import type { CollectionEntry } from "astro:content";
import BaseLayout from "../../layouts/BaseLayout.astro";
import SubmitPerkModal from "../../components/SubmitPerkModal.astro";

export async function getStaticPaths() {
  const perks = await getCollection("perks");
  return perks.map((perk: CollectionEntry<"perks">) => ({
    params: { slug: perk.id },
    props: { perk },
  }));
}

interface Props {
  perk: CollectionEntry<"perks">;
}

const { perk } = Astro.props;
const { data } = perk;

// Get related perks
const allPerks = await getCollection("perks");
const relatedPerks = allPerks
  .filter((p: CollectionEntry<"perks">) => p.id !== perk.id && p.data.categories.some((c: string) => data.categories.includes(c)))
  .slice(0, 3);

const repositoryUrl = import.meta.env.PUBLIC_REPO_URL ?? "https://github.com/jnd0/startup-perks";
const repositoryBranch = import.meta.env.PUBLIC_REPO_BRANCH ?? "main";
const submissionApiUrl = import.meta.env.PUBLIC_SUBMISSION_API_URL ?? "";
---

<BaseLayout title={`${data.company} - Perk Detail`} description={data.summary}>
  <main class="page-shell">
    <nav class="back-nav">
      <a href="/" class="back-link">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m15 18-6-6 6-6"/></svg>
        <span>Ledger</span>
      </a>
    </nav>

    <div class="detail-container">
      <header class="detail-header">
        <div class="header-main">
          <div class="brand-row">
            <span class="co-name">{data.company}</span>
            {data.verified && <span class="verified-pill">Verified</span>}
          </div>
          <h1 class="title" transition:name={`perk-title-${perk.id}`}>
            {data.amountDisplay}
          </h1>
          <p class="summary-lead">{data.summary}</p>
        </div>
        
        <div class="header-action-box">
          <a href={data.applyUrl} target="_blank" rel="noopener noreferrer" class="button button-primary large">
            Claim Offer
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M7 7h10v10"/><path d="M7 17 17 7"/></svg>
          </a>
          <p class="action-note">Official {data.company} Startup Program</p>
        </div>
      </header>

      <div class="grid-layout">
        <div class="main-column">
          <section class="info-section">
            <h2>The Perk</h2>
            <div class="prose">
              <p>{data.amountDisplay} in credits provided directly by {data.company}. This program is designed to help early-stage teams scale their infrastructure with enterprise-grade tools.</p>
              <ul>
                <li>Integrated product credits</li>
                <li>Direct technical support access</li>
                <li>Founder community resources</li>
              </ul>
            </div>
          </section>

          <section class="info-section">
            <h2>Eligibility</h2>
            <div class="eligibility-card">
              <p>{data.eligibility}</p>
              <div class="attribute-row">
                <div class="attr">
                  <span class="attr-label">Funding</span>
                  <span class="attr-val">{data.fundingStages.join(", ")}</span>
                </div>
                <div class="attr">
                  <span class="attr-label">Region</span>
                  <span class="attr-val">{data.regions.join(", ")}</span>
                </div>
              </div>
            </div>
          </section>
        </div>

        <aside class="side-column">
          <section class="meta-section">
            <h2>Details</h2>
            <dl class="meta-list">
              <div class="meta-item">
                <dt>Last Audited</dt>
                <dd>{data.lastVerified.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })}</dd>
              </div>
              <div class="meta-item">
                <dt>Category</dt>
                <dd>{data.categories.join(", ")}</dd>
              </div>
              <div class="meta-item">
                <dt>Status</dt>
                <dd class="active-status">Active</dd>
              </div>
            </dl>
          </section>

          <section class="related-section">
            <h2>Related</h2>
            <div class="related-stack">
              {relatedPerks.map((p: CollectionEntry<"perks">) => (
                <a href={`/perks/${p.id}`} class="related-item">
                  <span class="rel-co">{p.data.company}</span>
                  <span class="rel-amt">{p.data.amountDisplay}</span>
                </a>
              ))}
            </div>
          </section>
        </aside>
      </div>
    </div>

    <SubmitPerkModal repositoryUrl={repositoryUrl} baseBranch={repositoryBranch} submissionApiUrl={submissionApiUrl} />
  </main>
</BaseLayout>

<style>
  .back-nav {
    padding: 2rem 0;
  }

  .back-link {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    font-weight: 700;
    font-size: 0.9rem;
    color: var(--muted);
    transition: color 0.2s;
  }

  .back-link:hover {
    color: var(--fg);
  }

  .detail-container {
    padding-bottom: 6rem;
  }

  .detail-header {
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 4rem;
    align-items: center;
    padding-bottom: 4rem;
    border-bottom: 1px solid var(--line);
    margin-bottom: 4rem;
  }

  .brand-row {
    display: flex;
    align-items: center;
    gap: 1rem;
    margin-bottom: 1.5rem;
  }

  .co-name {
    font-size: 1.25rem;
    font-weight: 800;
    text-transform: uppercase;
    letter-spacing: -0.02em;
  }

  .verified-pill {
    font-size: 0.7rem;
    font-weight: 700;
    background: var(--highlight);
    padding: 0.2rem 0.6rem;
    border-radius: 4px;
    text-transform: uppercase;
  }

  .title {
    font-size: clamp(2.5rem, 6vw, 4rem);
    font-weight: 800;
    line-height: 1;
    margin: 0 0 1.5rem 0;
    letter-spacing: -0.04em;
  }

  .summary-lead {
    font-size: 1.25rem;
    color: var(--muted);
    max-width: 50ch;
    line-height: 1.4;
  }

  .header-action-box {
    text-align: center;
  }

  .button.large {
    padding: 1.25rem 2.5rem;
    font-size: 1.1rem;
    gap: 0.75rem;
  }

  .action-note {
    font-size: 0.8rem;
    color: var(--muted);
    margin-top: 1rem;
    font-family: var(--font-mono);
  }

  .grid-layout {
    display: grid;
    grid-template-columns: 1fr 320px;
    gap: 6rem;
  }

  .info-section h2, .meta-section h2, .related-section h2 {
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--muted);
    letter-spacing: 0.1em;
    margin-bottom: 2rem;
  }

  .prose {
    font-size: 1.15rem;
    line-height: 1.6;
  }

  .prose ul {
    padding-left: 1.5rem;
    margin-top: 2rem;
  }

  .prose li {
    margin-bottom: 0.75rem;
  }

  .eligibility-card {
    background: #fff;
    border: 1px solid var(--line);
    padding: 2rem;
    border-radius: var(--radius);
  }

  .eligibility-card p {
    font-size: 1.15rem;
    margin: 0 0 2rem 0;
  }

  .attribute-row {
    display: flex;
    gap: 3rem;
    border-top: 1px solid var(--line);
    padding-top: 1.5rem;
  }

  .attr {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  .attr-label {
    font-size: 0.7rem;
    font-weight: 700;
    color: var(--muted);
    text-transform: uppercase;
  }

  .attr-val {
    font-size: 0.95rem;
    font-weight: 600;
  }

  .meta-list {
    display: flex;
    flex-direction: column;
    gap: 1.5rem;
  }

  .meta-item dt {
    font-size: 0.75rem;
    font-weight: 700;
    color: var(--muted);
    margin-bottom: 0.25rem;
  }

  .meta-item dd {
    margin: 0;
    font-weight: 600;
    font-size: 0.95rem;
  }

  .active-status {
    color: #0d7a64;
  }

  .related-stack {
    display: flex;
    flex-direction: column;
    gap: 1rem;
  }

  .related-item {
    display: block;
    padding: 1.25rem;
    border: 1px solid var(--line);
    border-radius: var(--radius);
    transition: all 0.2s;
  }

  .related-item:hover {
    border-color: var(--fg);
    background: #fff;
  }

  .rel-co {
    display: block;
    font-size: 0.75rem;
    font-weight: 800;
    text-transform: uppercase;
    color: var(--muted);
    margin-bottom: 0.25rem;
  }

  .rel-amt {
    font-weight: 700;
    font-size: 1rem;
  }

  @media (max-width: 900px) {
    .detail-header {
      grid-template-columns: 1fr;
      gap: 2rem;
    }
    .grid-layout {
      grid-template-columns: 1fr;
      gap: 4rem;
    }
    .header-action-box {
      text-align: left;
    }
    .button.large {
      width: 100%;
    }
  }
</style>
